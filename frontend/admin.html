<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Airport Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">Airport MS Admin</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Back to Home</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4">Operations Dashboard</h2>

        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="gates-tab" data-bs-toggle="tab" data-bs-target="#gates"
                    type="button">Gates</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="baggage-tab" data-bs-toggle="tab" data-bs-target="#baggage"
                    type="button">Baggage</button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-4 bg-white rounded-bottom shadow-sm" id="adminTabsContent">

            <!-- Gates Tab -->
            <div class="tab-pane fade show active" id="gates" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Gates Management</h4>
                    <button class="btn btn-primary btn-sm" onclick="showCreateGateModal()">+ Add Gate</button>
                </div>
                <div id="gates-list" class="list-group">
                    Loading...
                </div>
            </div>

            <!-- Baggage Tab -->
            <div class="tab-pane fade" id="baggage" role="tabpanel">
                <h4>Baggage Operations</h4>
                <div id="baggage-list" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Booking Ref</th>
                                <th>Weight</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="baggage-tbody">
                            <!-- Rows injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Gate Modal -->
    <div class="modal fade" id="gateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Gate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="gate-form">
                        <div class="mb-3">
                            <label class="form-label">Terminal ID</label>
                            <input type="number" class="form-control" id="terminal-id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gate Code</label>
                            <input type="text" class="form-control" id="gate-code" required placeholder="A1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="gate-status">
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                                <option value="MAINTENANCE">MAINTENANCE</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Create</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Gates Logic
        async function loadGates() {
            try {
                const gates = await Api.get('/ops/gates');
                const container = document.getElementById('gates-list');

                if (!gates || gates.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">No gates found.</div>';
                    return;
                }

                let html = '';
                gates.forEach(gate => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${gate.code} <small class="text-muted">(Terminal ${gate.terminal_id})</small></h5>
                            </div>
                            <span class="badge ${gate.status === 'OPEN' ? 'bg-success' : 'bg-danger'}">${gate.status}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('gates-list').innerHTML = 'Error loading gates.';
            }
        }

        function showCreateGateModal() {
            new bootstrap.Modal(document.getElementById('gateModal')).show();
        }

        document.getElementById('gate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const terminalId = parseInt(document.getElementById('terminal-id').value);
            const code = document.getElementById('gate-code').value;
            const status = document.getElementById('gate-status').value;

            try {
                await Api.post('/ops/gates', { terminal_id: terminalId, code, status });
                alert('Gate created!');
                bootstrap.Modal.getInstance(document.getElementById('gateModal')).hide();
                loadGates(); // Refresh
            } catch (error) {
                alert('Failed to create gate: ' + error.message);
            }
        });

        // Baggage Logic
        async function loadBaggage() {
            try {
                const baggage = await Api.get('/ops/baggage');
                const tbody = document.getElementById('baggage-tbody');
                tbody.innerHTML = '';

                baggage.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.booking_id}</td>
                        <td>${item.weight} kg</td>
                        <td><span class="badge bg-secondary">${item.status}</span></td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateBaggageStatus(${item.id}, this.value)">
                                <option value="">Update Status...</option>
                                <option value="CHECKED_IN">CHECKED_IN</option>
                                <option value="LOADED">LOADED</option>
                                <option value="IN_TRANSIT">IN_TRANSIT</option>
                                <option value="DELIVERED">DELIVERED</option>
                            </select>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error(error);
            }
        }

        window.updateBaggageStatus = async (id, status) => {
            if (!status) return;
            try {
                await Api.patch(`/ops/baggage/${id}`, { status });
                loadBaggage(); // Refresh
            } catch (error) {
                alert('Update failed: ' + error.message);
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadGates();
            loadBaggage();
        });
    </script>
</body>

</html>